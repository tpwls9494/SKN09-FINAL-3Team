const ASSIST_STREAM_URL = '/assist/api/qwen/assist-stream/';

// === 1. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ & ì„¤ì • ===

const unifiedInferencePrompt = `
Below is a fixed instruction that guides the assistant to work as a Korean patent AI assistant.
The assistant must identify the task type and respond accordingly in Korean.
Think step-by-step before responding.
The final response should be written in Korean and MUST follow the EXACT format specified below.
**Respond in Korean.**

### Task Type: {task_type}

### Instruction:
{instruction}

### Context:
{context}

### Input:
{input}

### REQUIRED OUTPUT FORMAT (FOLLOW EXACTLY):
{output_format}

### Example Output Format:
{few_shot_example}

### Output:
`;

const INFERENCE_INSTRUCTIONS = {
  PATENT_FORM: `ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ íŠ¹í—ˆë²•ì— ë”°ë¼ ëª…ì„¸ì„œë¥¼ ì‘ì„±í•˜ëŠ” íŠ¹í—ˆ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ì•„ë˜ì˜ êµ¬ì„±ìš”ì†Œë³„ë¡œ ì •í™•í•˜ê³  êµ¬ì¡°í™”ëœ ë¬¸ì„œë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
ëª¨ë“  í•­ëª©ì€ íŠ¹í—ˆë²• ì œ42ì¡° ë° ì‹œí–‰ê·œì¹™ ì œ21ì¡°, ê°œì •ëœ ëª¨ë²” ëª…ì„¸ì„œ ì‘ì„±ë²•(2007.07.01. ì´í›„ ì ìš©)ì„ ì² ì €íˆ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.

ì£¼ì˜: í•œêµ­ì–´ë¡œë§Œ êµ¬ì‚¬í•´ì£¼ì„¸ìš”. ì¤‘êµ­ì–´(í•œì)ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`,
  PATENT_EVALUATION: `ì œì¶œëœ íŠ¹í—ˆ ëª…ì„¸ì„œë¥¼ ì „ë¬¸ì ìœ¼ë¡œ í‰ê°€í•˜ê³  ê°œì„  ë°©í–¥ì„ ì œì•ˆí•˜ì„¸ìš”.
ë‹¤ìŒ ê¸°ì¤€ì— ë”°ë¼ ë¶„ì„í•˜ê³  ì ìˆ˜ì™€ êµ¬ì²´ì ì¸ ê°œì„ ì‚¬í•­ì„ ì œì‹œí•˜ì„¸ìš”:
1. [ì‹ ê·œì„±] - ë™ì¼í•œ ë°œëª…ì´ ì´ë¯¸ ê³µê°œëœ ê²½ìš°
2. [ì§„ë³´ì„±] - í†µìƒì˜ ê¸°ìˆ ìì—ê²Œ ìëª…í•œ ê²½ìš°
3. [ì‚°ì—…ì  ì´ìš©ê°€ëŠ¥ì„±] - ì‚°ì—…ìƒ ì´ìš©í•  ìˆ˜ ìˆëŠ”ì§€
4. [ê¸°ì¬ë¶ˆë¹„] - ëª…ì„¸ì„œ ì‘ì„±ì´ ë²•ì  ìš”ê±´ì— ë§ëŠ”ì§€

ì£¼ì˜: í•œêµ­ì–´ë¡œë§Œ êµ¬ì‚¬í•´ì£¼ì„¸ìš”.`,
  PATENT_RECOMMENDATION: `í‰ê°€ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ íŠ¹í—ˆ ëª…ì„¸ì„œë¥¼ ê°œì„ í•˜ì—¬ ì™„ì „í•œ ëª…ì„¸ì„œë¥¼ ë‹¤ì‹œ ì‘ì„±í•˜ì„¸ìš”.
ê¸°ì¡´ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©´ì„œ í‰ê°€ì—ì„œ ì§€ì ëœ ë¬¸ì œì ë“¤ì„ í•´ê²°í•˜ì„¸ìš”.

ì£¼ì˜: í•œêµ­ì–´ë¡œë§Œ êµ¬ì‚¬í•´ì£¼ì„¸ìš”.`,
  PATENT_MODIFICATION: `ì‚¬ìš©ìì˜ ìˆ˜ì • ìš”ì²­ì— ë”°ë¼ í•´ë‹¹ ì„¹ì…˜ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì„¹ì…˜ì„ í•¨ê»˜ ìˆ˜ì •í•˜ì„¸ìš”.
ì„¹ì…˜ ê°„ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ì „ì²´ì ìœ¼ë¡œ ì¡°í™”ë¡œìš´ ëª…ì„¸ì„œê°€ ë˜ë„ë¡ ì‘ì„±í•˜ì„¸ìš”.

ì£¼ì˜: í•œêµ­ì–´ë¡œë§Œ êµ¬ì‚¬í•´ì£¼ì„¸ìš”.`
};

const OUTPUT_FORMATS = {
  PATENT_FORM: `
[ë°œëª…ì˜ ëª…ì¹­]
(ë°œëª…ëª…) {{ì˜ë¬¸ëª…}}

[ìš”ì•½]
(ë°œëª… ìš”ì•½)

[íŠ¹í—ˆì²­êµ¬ë²”ìœ„]
ì²­êµ¬í•­ 1: (ë…ë¦½í•­)
ì²­êµ¬í•­ 2: (ì¢…ì†í•­)

[ê¸°ìˆ ë¶„ì•¼]
(ê¸°ìˆ ë¶„ì•¼ ì„¤ëª…)

[ë°°ê²½ê¸°ìˆ ]
(ì¢…ë˜ ê¸°ìˆ  ì„¤ëª…)

[í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ]
(ë¬¸ì œì  ë° ê³¼ì œ)

[ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨]
(í•´ê²° ë°©ë²•)

[ë°œëª…ì˜ íš¨ê³¼]
(ê¸°ìˆ ì  íš¨ê³¼)

[ë°œëª…ì„ ì‹¤ì‹œí•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë‚´ìš©]
(êµ¬ì²´ì  ì‹¤ì‹œ ë‚´ìš©)

[ë„ë©´ì˜ ê°„ë‹¨í•œ ì„¤ëª…]
(ë„ë©´ ì„¤ëª…)
`,
  PATENT_EVALUATION: `
[ì‹ ê·œì„± í‰ê°€]
ì ìˆ˜: /10ì 
í‰ê°€ ì˜ê²¬:

[ì§„ë³´ì„± í‰ê°€]
ì ìˆ˜: /10ì 
í‰ê°€ ì˜ê²¬:

[ì‚°ì—…ì  ì´ìš© ê°€ëŠ¥ì„± í‰ê°€]
ì ìˆ˜: /10ì 
í‰ê°€ ì˜ê²¬:

[ê¸°ì¬ë¶ˆë¹„ í‰ê°€]
ì ìˆ˜: /10ì 
í‰ê°€ ì˜ê²¬:

[ì¢…í•© í‰ê°€]
ì´ì : /10ì 
ê°œì„  ë°©í–¥:
`,
  PATENT_RECOMMENDATION: `
[ë°œëª…ì˜ ëª…ì¹­]
(ê°œì„ ëœ ë°œëª…ëª…)

[ìš”ì•½]
(ê°œì„ ëœ ìš”ì•½)

[íŠ¹í—ˆì²­êµ¬ë²”ìœ„]
ì²­êµ¬í•­ 1: (ê°œì„ ëœ ë…ë¦½í•­)
ì²­êµ¬í•­ 2: (ê°œì„ ëœ ì¢…ì†í•­)

[ê¸°ìˆ ë¶„ì•¼]
(ê°œì„ ëœ ê¸°ìˆ ë¶„ì•¼)

[ë°°ê²½ê¸°ìˆ ]
(ê°œì„ ëœ ë°°ê²½ê¸°ìˆ )

[í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ]
(ê°œì„ ëœ ê³¼ì œ)

[ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨]
(ê°œì„ ëœ í•´ê²°ìˆ˜ë‹¨)

[ë°œëª…ì˜ íš¨ê³¼]
(ê°œì„ ëœ íš¨ê³¼)

[ë°œëª…ì„ ì‹¤ì‹œí•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë‚´ìš©]
(ê°œì„ ëœ êµ¬ì²´ì  ë‚´ìš©)

[ë„ë©´ì˜ ê°„ë‹¨í•œ ì„¤ëª…]
(ê°œì„ ëœ ë„ë©´ ì„¤ëª…)
`,
  PATENT_MODIFICATION: `
[ë°œëª…ì˜ ëª…ì¹­]
(ìˆ˜ì •ëœ ë°œëª…ëª…)

[ìš”ì•½]
(ìˆ˜ì •ëœ ìš”ì•½)

[íŠ¹í—ˆì²­êµ¬ë²”ìœ„]
ì²­êµ¬í•­ 1: (ìˆ˜ì •ëœ ë…ë¦½í•­)
ì²­êµ¬í•­ 2: (ìˆ˜ì •ëœ ì¢…ì†í•­)

[ê¸°ìˆ ë¶„ì•¼]
(ìˆ˜ì •ëœ ê¸°ìˆ ë¶„ì•¼)

[ë°°ê²½ê¸°ìˆ ]
(ìˆ˜ì •ëœ ë°°ê²½ê¸°ìˆ )

[í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ]
(ìˆ˜ì •ëœ ê³¼ì œ)

[ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨]
(ìˆ˜ì •ëœ í•´ê²°ìˆ˜ë‹¨)

[ë°œëª…ì˜ íš¨ê³¼]
(ìˆ˜ì •ëœ íš¨ê³¼)

[ë°œëª…ì„ ì‹¤ì‹œí•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë‚´ìš©]
(ìˆ˜ì •ëœ êµ¬ì²´ì  ë‚´ìš©)

[ë„ë©´ì˜ ê°„ë‹¨í•œ ì„¤ëª…]
(ìˆ˜ì •ëœ ë„ë©´ ì„¤ëª…)
`
};

const FEW_SHOT_EXAMPLES = {
  PATENT_FORM: `
[ë°œëª…ì˜ ëª…ì¹­]
AI ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ë†ì—… ì‹œìŠ¤í…œ {{AI-based Smart Agriculture System}}

[ê¸°ìˆ ë¶„ì•¼]
ë³¸ ë°œëª…ì€ ì¸ê³µì§€ëŠ¥ ê¸°ìˆ ì„ í™œìš©í•œ ìŠ¤ë§ˆíŠ¸ ë†ì—… ì‹œìŠ¤í…œì— ê´€í•œ ê²ƒì´ë‹¤.

[ë°°ê²½ê¸°ìˆ ]
ì¢…ë˜ì˜ ë†ì—… ë°©ì‹ì€ ë†ì‘ë¬¼ ê´€ë¦¬ì— ìˆì–´ ë§ì€ ì‹œê°„ê³¼ ë…¸ë™ë ¥ì´ ì†Œìš”ë˜ì—ˆë‹¤...
`,
  PATENT_EVALUATION: `
[ì‹ ê·œì„± í‰ê°€]
ì ìˆ˜: 7/10ì 
í‰ê°€ ì˜ê²¬: ê¸°ì¡´ ê¸°ìˆ ê³¼ ì°¨ë³„ì„±ì´ ìˆìœ¼ë‚˜...

[ì§„ë³´ì„± í‰ê°€]
ì ìˆ˜: 6/10ì 
í‰ê°€ ì˜ê²¬: í†µìƒì˜ ê¸°ìˆ ìì—ê²Œ ìëª…í•œ ìˆ˜ì¤€...
`,
  PATENT_RECOMMENDATION: `
[ë°œëª…ì˜ ëª…ì¹­]
AI ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ë†ì—… ì‹œìŠ¤í…œ {{AI-based Smart Agriculture System}}

[ê¸°ìˆ ë¶„ì•¼]
ë³¸ ë°œëª…ì€ ì¸ê³µì§€ëŠ¥ ê¸°ìˆ ì„ í™œìš©í•œ ìŠ¤ë§ˆíŠ¸ ë†ì—… ì‹œìŠ¤í…œì— ê´€í•œ ê²ƒì´ë‹¤...
`,
  PATENT_MODIFICATION: `
[ë°œëª…ì˜ ëª…ì¹­]
AI ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ë†ì—… ì‹œìŠ¤í…œ {{AI-based Smart Agriculture System}}

[ê¸°ìˆ ë¶„ì•¼]
ë³¸ ë°œëª…ì€ ì¸ê³µì§€ëŠ¥ ê¸°ìˆ ì„ í™œìš©í•œ ìŠ¤ë§ˆíŠ¸ ë†ì—… ì‹œìŠ¤í…œì— ê´€í•œ ê²ƒì´ë‹¤...
`
};

// ì„¹ì…˜ ê´€ê³„ ë§¤í•‘
const SECTION_RELATIONSHIPS = {
  "ë°œëª…ì˜ ëª…ì¹­": ["ë°œëª…ì˜ ëª…ì¹­", "ê¸°ìˆ ë¶„ì•¼"],
  "ê¸°ìˆ ë¶„ì•¼": ["ê¸°ìˆ ë¶„ì•¼", "ë°°ê²½ê¸°ìˆ "],
  "ë°°ê²½ê¸°ìˆ ": ["ë°°ê²½ê¸°ìˆ ", "í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ"],
  "í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ": ["í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ", "ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨", "ë°œëª…ì˜ íš¨ê³¼"],
  "ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨": ["ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨", "í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ", "ë°œëª…ì„ ì‹¤ì‹œí•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë‚´ìš©", "ë°œëª…ì˜ íš¨ê³¼"],
  "ë°œëª…ì˜ íš¨ê³¼": ["ë°œëª…ì˜ íš¨ê³¼", "í•´ê²°í•˜ë ¤ëŠ” ê³¼ì œ", "ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨"],
  "ë°œëª…ì„ ì‹¤ì‹œí•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë‚´ìš©": ["ë°œëª…ì„ ì‹¤ì‹œí•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë‚´ìš©", "ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨"]
};

function buildPrompt(taskType, context, input) {
  return unifiedInferencePrompt
    .replace('{task_type}',       taskType)
    .replace('{instruction}',     INFERENCE_INSTRUCTIONS[taskType])
    .replace('{context}',         context || '')
    .replace('{input}',           input || '')
    .replace('{output_format}',   OUTPUT_FORMATS[taskType])
    .replace('{few_shot_example}', FEW_SHOT_EXAMPLES[taskType] || '');
}

// ìŠ¤íŠ¸ë¦¬ë° í•¨ìˆ˜ - ### Output: ì´í›„ë¶€í„° í‘œì‹œ
async function openAssistStreamPost(payload, onToken, onDone, onError) {
  try {
    const response = await fetch(ASSIST_STREAM_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
        'Accept': 'text/event-stream',
        'Cache-Control': 'no-cache'
      },
      body: JSON.stringify({
        ...payload,
        max_new_tokens: 32768
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let fullResponse = '';
    let showingOutput = false;

    while (true) {
      const { done, value } = await reader.read();
      
      if (done) {
        onDone();
        break;
      }

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') {
            onDone();
            return;
          }
          
          try {
            const parsed = JSON.parse(data);
            if (parsed.type === 'token') {
              fullResponse += parsed.content;
              
              // ### Output: ì´í›„ì˜ ë‚´ìš©ë§Œ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
              if (!showingOutput && fullResponse.includes('### Output:')) {
                showingOutput = true;
                const outputIndex = fullResponse.indexOf('### Output:') + '### Output:'.length;
                const outputContent = fullResponse.substring(outputIndex).trim();
                onToken(outputContent);
              } else if (showingOutput) {
                onToken(parsed.content);
              }
            } else if (parsed.type === 'error') {
              onError(parsed.message);
              return;
            }
          } catch (e) {
            console.warn('JSON íŒŒì‹± ì˜¤ë¥˜:', e, data);
          }
        }
      }
    }
  } catch (error) {
    console.error('ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜:', error);
    onError(error.message);
  }
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getCSRFToken() {
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'csrftoken') {
      return value;
    }
  }
  
  const metaToken = document.querySelector('meta[name="csrf-token"]');
  if (metaToken) {
    return metaToken.getAttribute('content');
  }
  
  const hiddenToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
  if (hiddenToken) {
    return hiddenToken.value;
  }
  
  return '';
}

function collectFormData() {
  const type = document.querySelector('input[name="applicant_type"]:checked')?.value || 'corporation';

  const data = {
    tech_name: getVal('tech_name'),
    tech_description: getVal('tech_description'),
    problem_solved: getVal('problem_solved'),
    tech_differentiation: getVal('tech_differentiation'),
    application_field: getVal('application_field'),
    components_functions: getVal('components_functions'),
    implementation_example: getVal('implementation_example'),
    drawing_description: getVal('drawing_description'),
    applicant_type: type,
    applicant_info: getApplicantInfo(type),
    inventors: getInventors()
  };

  return data;
}

function getVal(id) {
  const element = document.getElementById(id);
  return element ? element.value : '';
}

function getApplicantInfo(type) {
  if (type === 'corporation') {
    return {
      type: 'corporation',
      corporation_name: getVal('corporation_name'),
      representative_name: getVal('representative_name'),
      address: getVal('corporation_address'),
      nationality: getVal('corporation_nationality')
    };
  }
  return {
    type: 'individual',
    name: getVal('individual_name'),
    address: getVal('individual_address'),
    nationality: getVal('individual_nationality')
  };
}

function getInventors() {
  const inventors = [];
  document.querySelectorAll('.inventor-item').forEach((item, i) => {
    const name = getVal(`inventor_name_${i + 1}`);
    if (name.trim()) {
      inventors.push({
        name: name.trim(),
        address: getVal(`inventor_address_${i + 1}`).trim(),
        nationality: getVal(`inventor_nationality_${i + 1}`)
      });
    }
  });
  return inventors;
}

// ìµœì¢… ì‘ë‹µ ì¶”ì¶œ í•¨ìˆ˜
function extractFinalContent(fullResponse) {
  if (fullResponse.includes('### Output:')) {
    const outputIndex = fullResponse.indexOf('### Output:') + '### Output:'.length;
    return fullResponse.substring(outputIndex).trim();
  }
  return fullResponse.trim();
}

// === AI ìˆ˜ì • ëª¨ë‹¬ì°½ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
function createAIModificationModal() {
  // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
  const existingModal = document.getElementById('aiModificationModal');
  if (existingModal) {
    existingModal.remove();
  }

  // ëª¨ë‹¬ HTML ìƒì„±
  const modalHTML = `
    <div id="aiModificationModal" class="ai-modal-overlay" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(25, 47, 89, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    ">
      <div class="ai-modal-content" style="
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        border-radius: 16px;
        padding: 28px;
        width: 90%;
        max-width: 900px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.1);
        position: relative;
      ">
        <div class="ai-modal-header" style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
          padding-bottom: 18px;
          border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        ">
          <h2 style="
            margin: 0;
            color: white;
            font-size: 26px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
          ">AI ëª…ì„¸ì„œ ìˆ˜ì •</h2>
          <button id="closeAIModal" style="
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: background 0.2s;
          ">Ã—</button>
        </div>
        
        <div class="ai-modal-body">
          <div id="aiModificationResult" style="
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
          "></div>
        </div>
      </div>
    </div>
  `;

  // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  setupAIModalEventListeners();
}

function setupAIModalEventListeners() {
  const modal = document.getElementById('aiModificationModal');
  const closeBtn = document.getElementById('closeAIModal');

  // ëª¨ë‹¬ ë‹«ê¸°
  function closeModal() {
    if (modal) {
      modal.remove();
    }
  }

  closeBtn.addEventListener('click', closeModal);
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // ESC í‚¤ë¡œ ë‹«ê¸°
  document.addEventListener('keydown', function handleEscape(e) {
    if (e.key === 'Escape' && modal) {
      closeModal();
      document.removeEventListener('keydown', handleEscape);
    }
  });

  // ë‹«ê¸° ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼
  closeBtn.addEventListener('mouseenter', () => {
    closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
  });
  
  closeBtn.addEventListener('mouseleave', () => {
    closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
  });
}

function executeAIModification(userRequest, currentDraft) {
  const resultDiv = document.getElementById('aiModificationResult');
  
  // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™” ë° í‘œì‹œ
  resultDiv.innerHTML = '';
  resultDiv.style.display = 'block';

  const context = `í˜„ì¬ ëª…ì„¸ì„œ:\n${currentDraft}\n\nìˆ˜ì • ìš”ì²­:\n${userRequest}`;
  const prompt = buildPrompt('PATENT_MODIFICATION', context, userRequest);
  const payload = { query: prompt };

  let fullModificationContent = '';

  openAssistStreamPost(
    payload,
    token => {
      fullModificationContent += token;
      resultDiv.textContent = fullModificationContent;
      // ìë™ ìŠ¤í¬ë¡¤
      resultDiv.scrollTop = resultDiv.scrollHeight;
    },
    () => {
      console.log('AI ìˆ˜ì • ì™„ë£Œ');
      const finalModification = extractFinalContent(fullModificationContent);
      
      // ìˆ˜ì •ëœ ë‚´ìš©ì„ ì„ì‹œ ì €ì¥
      App.data.pendingModification = finalModification;
      
      // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
      showConfirmationDialog();
    },
    err => {
      alert('AI ìˆ˜ì • ì˜¤ë¥˜: ' + err);
    }
  );
}

function showConfirmationDialog() {
  // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
  const confirmDialog = document.createElement('div');
  confirmDialog.id = 'aiConfirmDialog';
  confirmDialog.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(25, 47, 89, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10002;
  `;

  confirmDialog.innerHTML = `
    <div class="confirm-dialog-content" style="
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.2);
    ">
      <div style="
        font-size: 52px;
        margin-bottom: 20px;
      ">ğŸ¤–</div>
      <h3 style="
        margin: 0 0 16px 0;
        color: white;
        font-size: 22px;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      ">AI ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
      <p style="
        margin: 0 0 28px 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 16px;
        line-height: 1.5;
      ">ìƒì„±ëœ ìˆ˜ì • ë‚´ìš©ì„ ëª…ì„¸ì„œì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div style="
        display: flex;
        gap: 16px;
        justify-content: center;
      ">
        <button id="confirmNo" style="
          padding: 14px 28px;
          border: 2px solid rgba(255, 255, 255, 0.3);
          background: rgba(255, 255, 255, 0.1);
          color: white;
          border-radius: 10px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          min-width: 100px;
          transition: all 0.2s;
        ">ì•„ë‹ˆì˜¤</button>
        <button id="confirmYes" style="
          padding: 14px 28px;
          border: none;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border-radius: 10px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          min-width: 100px;
          box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
          transition: all 0.2s;
        ">ì˜ˆ</button>
      </div>
    </div>
  `;

  document.body.appendChild(confirmDialog);

  // ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼
  const yesBtn = document.getElementById('confirmYes');
  const noBtn = document.getElementById('confirmNo');
  
  yesBtn.addEventListener('mouseenter', () => {
    yesBtn.style.transform = 'translateY(-2px)';
    yesBtn.style.boxShadow = '0 6px 20px rgba(16, 185, 129, 0.6)';
  });
  
  yesBtn.addEventListener('mouseleave', () => {
    yesBtn.style.transform = 'translateY(0)';
    yesBtn.style.boxShadow = '0 4px 15px rgba(16, 185, 129, 0.4)';
  });
  
  noBtn.addEventListener('mouseenter', () => {
    noBtn.style.background = 'rgba(255, 255, 255, 0.2)';
    noBtn.style.transform = 'translateY(-2px)';
  });
  
  noBtn.addEventListener('mouseleave', () => {
    noBtn.style.background = 'rgba(255, 255, 255, 0.1)';
    noBtn.style.transform = 'translateY(0)';
  });

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  yesBtn.addEventListener('click', () => {
    confirmDialog.remove();
    applyAIModificationToMain();
    // ëª¨ë‹¬ì°½ë„ ë‹«ê¸°
    const modal = document.getElementById('aiModificationModal');
    if (modal) modal.remove();
  });

  noBtn.addEventListener('click', () => {
    confirmDialog.remove();
    // ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  ëª¨ë‹¬ì°½ ìœ ì§€
  });

  // ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
  confirmDialog.addEventListener('click', (e) => {
    if (e.target === confirmDialog) {
      confirmDialog.remove();
    }
  });

  // ESC í‚¤ë¡œ ë‹«ê¸°
  document.addEventListener('keydown', function handleEscape(e) {
    if (e.key === 'Escape' && confirmDialog) {
      confirmDialog.remove();
      document.removeEventListener('keydown', handleEscape);
    }
  });
}

function applyAIModificationToMain() {
  if (!App.data.pendingModification) {
    alert('ë°˜ì˜í•  ìˆ˜ì • ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // ìˆ˜ì •ëœ ëª…ì„¸ì„œë¥¼ í˜„ì¬ ì´ˆì•ˆìœ¼ë¡œ ì—…ë°ì´íŠ¸
  App.data.currentDraftContent = App.data.pendingModification;
  
  // í‰ê°€ ìºì‹œ ë¬´íš¨í™” (ëª…ì„¸ì„œê°€ ìˆ˜ì •ë˜ì—ˆìœ¼ë¯€ë¡œ)
  invalidateEvaluationCache();
  
  // Draft íŒ¨ë„ì—ë„ ë°˜ì˜
  if (App.draft && App.draft.display) {
    App.draft.display(App.data.pendingModification);
  }
  
  // ì„ì‹œ ì €ì¥ëœ ìˆ˜ì • ë‚´ìš© ì œê±°
  delete App.data.pendingModification;
  
  // ì„±ê³µ ì•Œë¦¼
  if (App.utils && App.utils.showNotification) {
    App.utils.showNotification('âœ… ëª…ì„¸ì„œ ìˆ˜ì •ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } else {
    alert('ëª…ì„¸ì„œ ìˆ˜ì •ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // === 1. ë³€í™˜ ë²„íŠ¼: ëª…ì„¸ì„œ ì´ˆì•ˆ ìƒì„± ===
  const convertBtn = document.querySelector('.convert-btn');
  if (convertBtn) {
    convertBtn.addEventListener('click', e => {
      e.preventDefault();
      const formData = collectFormData();
      
      if (!validateFormData(formData)) {
        return;
      }
      
      const prompt = buildPrompt('PATENT_FORM', '', JSON.stringify(formData));
      const payload = { query: prompt };

      const noDraftMessage = document.getElementById('noDraftMessage');
      const draftContent = document.getElementById('draftContent');

      if (noDraftMessage) noDraftMessage.style.display = 'none';
      if (draftContent) {
        draftContent.style.display = 'block';
        draftContent.innerHTML = '';

        const streamDiv = document.createElement('div');
        streamDiv.className = 'markdown-content';
        streamDiv.style.whiteSpace = 'pre-wrap';
        draftContent.appendChild(streamDiv);

        let fullContent = '';

        openAssistStreamPost(
          payload,
          token => {
            fullContent += token;
            streamDiv.innerText = fullContent;
          },
          () => {
            console.log('ëª…ì„¸ì„œ ìƒì„± ì™„ë£Œ');
            const finalContent = extractFinalContent(fullContent);
            
            App.data.currentDraftContent = finalContent;
            
            // ìƒˆë¡œìš´ ëª…ì„¸ì„œê°€ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ í‰ê°€ ìºì‹œ ë¬´íš¨í™”
            invalidateEvaluationCache();
            
            if (App.draft && App.draft.display) {
              App.draft.display(finalContent);
            }
            
            // í…œí”Œë¦¿ ì €ì¥ (ë³€í™˜ ë²„íŠ¼ì—ì„œë§Œ)
            saveTemplate(formData, finalContent);
          },
          err => alert('ëª…ì„¸ì„œ ìƒì„± ì˜¤ë¥˜: ' + err)
        );
      }
    });
  }

  // === 2. í‰ê°€ ë²„íŠ¼: ëª…ì„¸ì„œ í‰ê°€ (ìºì‹œ ì§€ì›) ===
  const evalBtn = document.querySelector('.draft_evalbutton');
  if (evalBtn) {
    evalBtn.addEventListener('click', () => {
      const currentDraft = App.data.currentDraftContent || document.getElementById('draftContent')?.innerText || '';
      
      if (!currentDraft.trim()) {
        alert('í‰ê°€í•  ëª…ì„¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // í‰ê°€ ëª¨ë“œë¡œ ì „í™˜
      const fullPanel = document.getElementById('fullPanelContainer');
      const evaluationLayout = document.getElementById('evaluationLayout');
      
      if (fullPanel && evaluationLayout) {
        fullPanel.style.display = 'none';
        evaluationLayout.style.display = 'flex';
        
        // ì¢Œì¸¡ì— ì›ë³¸ ëª…ì„¸ì„œ í‘œì‹œ
        const leftPanel = evaluationLayout.querySelector('.draft-panel-left .panel-body');
        if (leftPanel) {
          leftPanel.innerHTML = '';
          const markdownDiv = document.createElement('div');
          markdownDiv.className = 'markdown-content';
          markdownDiv.innerHTML = App.utils.convertMarkdownToHTML(currentDraft);
          leftPanel.appendChild(markdownDiv);
        }
        
        const evaluationContent = document.getElementById('evaluationContent');
        if (evaluationContent) {
          // ìºì‹œëœ í‰ê°€ê°€ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
          if (App.data.evaluationCached && App.data.currentEvaluation) {
            evaluationContent.innerHTML = '';
            evaluationContent.innerText = App.data.currentEvaluation;
            evaluationContent.style.display = 'block';
            App.utils.showNotification('ì €ì¥ëœ í‰ê°€ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
            return;
          }
          
          // ìƒˆë¡œìš´ í‰ê°€ ìš”ì²­
          const prompt = buildPrompt('PATENT_EVALUATION', '', currentDraft);
          const payload = { query: prompt };
          
          evaluationContent.innerHTML = '';
          evaluationContent.style.display = 'block';

          let fullEvaluationContent = '';

          openAssistStreamPost(
            payload,
            token => {
              fullEvaluationContent += token;
              evaluationContent.innerText = fullEvaluationContent;
            },
            () => {
              console.log('í‰ê°€ ì™„ë£Œ');
              const finalEvaluation = extractFinalContent(fullEvaluationContent);
              
              // í‰ê°€ ê²°ê³¼ ìºì‹œì— ì €ì¥
              App.data.currentEvaluation = finalEvaluation;
              App.data.evaluationCached = true;
              
              App.utils.showNotification('í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            },
            err => alert('í‰ê°€ ì˜¤ë¥˜: ' + err)
          );
        }
      }
    });
  }

  // === 3. ì¶”ì²œ ë²„íŠ¼: í‰ê°€ ê¸°ë°˜ ëª…ì„¸ì„œ ê°œì„  ===
  const recommendBtn = document.querySelector('.draft-modifybutton');
  if (recommendBtn) {
    recommendBtn.addEventListener('click', () => {
      const currentDraft = App.data.currentDraftContent || '';
      const currentEvaluation = App.data.currentEvaluation || '';
      
      if (!currentDraft.trim()) {
        alert('ê°œì„ í•  ëª…ì„¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!currentEvaluation.trim()) {
        alert('ë¨¼ì € í‰ê°€ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì¶”ì²œ ìš”ì²­ ì‹¤í–‰
      requestRecommendation(currentDraft, currentEvaluation);
    });
  }

  // ì¶”ì²œ ìš”ì²­ í•¨ìˆ˜
  function requestRecommendation(currentDraft, currentEvaluation) {
    const context = `ì›ë³¸ ëª…ì„¸ì„œ:\n${currentDraft}\n\ní‰ê°€ ê²°ê³¼:\n${currentEvaluation}`;
    const prompt = buildPrompt('PATENT_RECOMMENDATION', context, '');
    const payload = { query: prompt };

    const evaluationContent = document.getElementById('evaluationContent');
    const panelTitle = document.getElementById('eval-header');
    
    if (evaluationContent && panelTitle) {
      // í—¤ë” ë³€ê²½
      panelTitle.innerHTML = '<div class="panel-title">ì¶”ì²œëœ ê°œì„  ëª…ì„¸ì„œ</div>';
      
      evaluationContent.innerHTML = '';
      evaluationContent.style.color = '#FF5A5A'; // ì¶”ì²œ ë‚´ìš© ê°•ì¡°

      let fullRecommendationContent = '';

      openAssistStreamPost(
        payload,
        token => {
          fullRecommendationContent += token;
          evaluationContent.innerText = fullRecommendationContent;
        },
        () => {
          console.log('ì¶”ì²œ ì™„ë£Œ');
          const finalRecommendation = extractFinalContent(fullRecommendationContent);
          
          // ì¶”ì²œ ê²°ê³¼ ì €ì¥
          App.data.currentRecommendation = finalRecommendation;
          
          // ì¶”ì²œ ë²„íŠ¼ë“¤ í‘œì‹œ
          showRecommendationButtons();
          
          App.utils.showNotification('ê°œì„ ëœ ëª…ì„¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        err => alert('ì¶”ì²œ ì˜¤ë¥˜: ' + err)
      );
    }
  }

  // ì¶”ì²œ ë²„íŠ¼ë“¤ í‘œì‹œ
  function showRecommendationButtons() {
    const container = document.getElementById("after-eval");
    if (!container) return;

    // ê¸°ì¡´ ë²„íŠ¼ë“¤ ì œê±°
    container.innerHTML = "";

    // ì·¨ì†Œ ë²„íŠ¼
    const cancelBtn = document.createElement("button");
    cancelBtn.className = "draft-cancelbutton";
    cancelBtn.innerText = "ì·¨ì†Œ";
    cancelBtn.onclick = function () {
      restoreEvaluationView();
    };

    // ì¬ì¶”ì²œ ë²„íŠ¼
    const reRecommendBtn = document.createElement("button");
    reRecommendBtn.className = "draft-reRecommentbutton";
    reRecommendBtn.innerText = "ì¬ì¶”ì²œ";
    reRecommendBtn.onclick = function () {
      const currentDraft = App.data.currentDraftContent || '';
      const currentEvaluation = App.data.currentEvaluation || '';
      requestRecommendation(currentDraft, currentEvaluation);
    };

    // ë°˜ì˜ ë²„íŠ¼
    const applyBtn = document.createElement("button");
    applyBtn.className = "draft-modifybutton";
    applyBtn.style.border = "2px solid white";
    applyBtn.innerText = "ë°˜ì˜";
    applyBtn.onclick = function () {
      applyRecommendation();
    };

    // ë²„íŠ¼ ì¶”ê°€
    container.appendChild(cancelBtn);
    container.appendChild(reRecommendBtn);
    container.appendChild(applyBtn);
  }

  // í‰ê°€ í™”ë©´ ë³µì›
  function restoreEvaluationView() {
    const evaluationContent = document.getElementById('evaluationContent');
    const panelTitle = document.getElementById('eval-header');
    const container = document.getElementById("after-eval");

    if (panelTitle) {
      panelTitle.innerHTML = '<div class="panel-title">ì´ˆì•ˆì— ëŒ€í•œ í‰ê°€</div>';
    }

    if (evaluationContent) {
      evaluationContent.style.color = ''; // ì›ë˜ ìƒ‰ìƒìœ¼ë¡œ ë³µì›
      if (App.data.currentEvaluation) {
        evaluationContent.innerText = App.data.currentEvaluation;
      }
    }

    if (container) {
      container.innerHTML = `
        <button type="button" class="draft-cancelbutton" onclick="App.navigation.backToNormal()">ì·¨ì†Œ</button>
        <button type="button" class="draft-modifybutton" onclick="document.querySelector('.draft-modifybutton').click()">ì¶”ì²œ</button>
      `;
    }
  }

  // ì¶”ì²œ ë‚´ìš© ë°˜ì˜
  function applyRecommendation() {
    if (!App.data.currentRecommendation) {
      alert('ë°˜ì˜í•  ì¶”ì²œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // í˜„ì¬ ì´ˆì•ˆì„ ì¶”ì²œ ë‚´ìš©ìœ¼ë¡œ êµì²´
    App.data.currentDraftContent = App.data.currentRecommendation;
    
    // í‰ê°€ ìºì‹œ ë¬´íš¨í™” (ìƒˆë¡œìš´ ì´ˆì•ˆì´ë¯€ë¡œ)
    App.data.evaluationCached = false;
    App.data.currentEvaluation = '';
    
    // Draft íŒ¨ë„ì— ë°˜ì˜
    if (App.draft && App.draft.display) {
      App.draft.display(App.data.currentRecommendation);
    }
    
    // ì¼ë°˜ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    const fullPanel = document.getElementById('fullPanelContainer');
    const evaluationLayout = document.getElementById('evaluationLayout');
    
    if (fullPanel && evaluationLayout) {
      fullPanel.style.display = 'flex';
      evaluationLayout.style.display = 'none';
    }
    
    App.utils.showNotification('ì¶”ì²œ ë‚´ìš©ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }

  // === 4. AI ìš”ì²­ ë²„íŠ¼: í”„ë¡¬í”„íŠ¸ ì…ë ¥ í›„ ëª¨ë‹¬ì°½ ì—´ë¦¼ ===
  const aiRequestBtn = document.getElementById('sent-ai-request');
  if (aiRequestBtn) {
    aiRequestBtn.addEventListener('click', () => {
      const userRequest = document.getElementById('input-requestai')?.value || '';
      const currentDraft = App.data.currentDraftContent || '';
      
      if (!userRequest.trim()) {
        alert('ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!currentDraft.trim()) {
        alert('ìˆ˜ì •í•  ëª…ì„¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ëª¨ë‹¬ì°½ ìƒì„± ë° AI ìˆ˜ì • ìš”ì²­ ìë™ ì‹¤í–‰
      createAIModificationModal();
      
      // ëª¨ë‹¬ì°½ì´ ìƒì„±ëœ í›„ AI ìˆ˜ì • ìš”ì²­ ì‹¤í–‰
      setTimeout(() => {
        executeAIModification(userRequest, currentDraft);
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('input-requestai').value = '';
      }, 100);
    });
  }

  // ê¸°ì¡´ AI ìš”ì²­ ê²°ê³¼ ì˜ì—­ì€ ìˆ¨ê¹€ ì²˜ë¦¬ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
  const aiRequestResult = document.getElementById('aiRequestResult');
  if (aiRequestResult) {
    aiRequestResult.style.display = 'none';
  }

  // í‰ê°€ ìºì‹œ ë¬´íš¨í™” í•¨ìˆ˜
  function invalidateEvaluationCache() {
    App.data.evaluationCached = false;
    App.data.currentEvaluation = '';
    console.log('í‰ê°€ ìºì‹œê°€ ë¬´íš¨í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
});

// í¼ ê²€ì¦
function validateFormData(formData) {
  if (!formData.tech_name || !formData.tech_name.trim()) {
    alert('ê¸°ìˆ ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return false;
  }
  
  if (!formData.tech_description || !formData.tech_description.trim()) {
    alert('ê¸°ìˆ  ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return false;
  }
  
  if (!formData.problem_solved || !formData.problem_solved.trim()) {
    alert('í•´ê²°í•˜ë ¤ëŠ” ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return false;
  }
  
  if (!formData.inventors || formData.inventors.length === 0) {
    alert('ìµœì†Œ 1ëª…ì˜ ë°œëª…ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return false;
  }
  
  return true;
}

// í…œí”Œë¦¿ ì €ì¥ (ë³€í™˜ ë²„íŠ¼ì—ì„œë§Œ í˜¸ì¶œ)
function saveTemplate(formData, content) {
  const saveData = {
    ...formData,
    sc_flag: 'create',
    version: 'v1',
    create_draft: content,
    user_id: currentUser.id
  };
  
  fetch('/assist/insert_patent_report/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken(),
    },
    body: JSON.stringify(saveData)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
    }
    return response.json();
  })
  .then(data => {
    if (data.status === "success") {
      window.CURRENT_TEMPLATE_ID = data.template_id;
      App.data.currentDraftId = data.draft_id;
      
      // ë²„íŠ¼ë“¤ í™œì„±í™”
      const buttons = document.querySelectorAll(
        '.draft_self_modifybutton, .draft_request_aibutton, .draft_evalbutton, .draft_downloadbutton'
      );
      
      buttons.forEach(button => {
        button.disabled = false;
        button.classList.add('dynamic-hover');
      });
      
      // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
      if (App.history && App.history.renderMyHistory) {
        App.history.renderMyHistory();
      }
      
      App.utils.showNotification('ëª…ì„¸ì„œê°€ ìƒì„±ë˜ê³  í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      throw new Error(data.message || 'ì €ì¥ ì‹¤íŒ¨');
    }
  })
  .catch(error => {
    console.error('í…œí”Œë¦¿ ì €ì¥ ì˜¤ë¥˜:', error);
    App.utils.showNotification('í…œí”Œë¦¿ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
  });
}

// í…œí”Œë¦¿ ê´€ë¦¬ ì „ìš© ëª¨ë“ˆ
(function() {
  'use strict';

  const buttons = document.querySelectorAll(
    '.draft_self_modifybutton, .draft_request_aibutton, .draft_evalbutton, .draft_downloadbutton'
  );

  window.addEventListener('DOMContentLoaded', ()=> {
    buttons.forEach(button => {
      button.disabled = true;
    });
  });

  let inventorCount = 1;
  window.CURRENT_TEMPLATE_ID = null;

  if (typeof window.currentDraftContent === 'undefined') {
    window.currentDraftContent = '';
  }

  document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    initializeTemplate();
  });

  function initializeApp() {
    if (typeof window.App === 'undefined') {
      window.App = {
        data: { 
          currentDraftContent: '',
          currentEvaluation: '',
          currentDraftId: null,
          evaluationCached: false // í‰ê°€ ìºì‹œ ìƒíƒœ
        },
        history: null,
        template: null,
        utils: { showNotification: console.log }
      };
    }
    if (!window.App.data) {
      window.App.data = { 
        currentDraftContent: '',
        currentEvaluation: '',
        currentDraftId: null,
        evaluationCached: false
      };
    }
  }

  function initializeTemplate() {
    const templateForm = document.getElementById('templateForm');
    if (!templateForm) return;

    document.querySelectorAll('input[name="applicant_type"]').forEach(radio => {
      radio.addEventListener('change', toggleApplicantType);
    });

    const addBtn = document.getElementById('addInventorBtn');
    if (addBtn) addBtn.addEventListener('click', addInventor);

    document.querySelectorAll('.text-input, .textarea-input').forEach(input => {
      input.addEventListener('input', () => updateCharCounter(input));
      updateCharCounter(input);
    });

    toggleApplicantType();
  }

  function toggleApplicantType() {
    const type = document.querySelector('input[name="applicant_type"]:checked')?.value;
    const corp = document.getElementById('corporationInfo');
    const ind = document.getElementById('individualInfo');

    if (corp && ind) {
      if (type === 'corporation') {
        corp.style.display = 'block';
        ind.style.display = 'none';
      } else {
        corp.style.display = 'none';
        ind.style.display = 'block';
      }
    }
  }

  function addInventor() {
    const container = document.getElementById('inventors-container');
    const count = document.querySelectorAll('.inventor-item').length;

    if (count >= 10) {
      showMessage('ìµœëŒ€ 10ëª…ê¹Œì§€ë§Œ ë°œëª…ìë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }

    inventorCount = count + 1;
    container.insertAdjacentHTML('beforeend', createInventorHTML(inventorCount));
  }

  function createInventorHTML(num) {
    return `
      <div class="inventor-item" data-inventor="${num}">
        <div class="inventor-header">
          <h4>ë°œëª…ì ${num}</h4>
          <button type="button" class="remove-inventor-btn" onclick="removeInventor(${num})" ${num === 1 ? 'style="display:none"' : ''}>
            <span class="remove-icon">Ã—</span>
          </button>
        </div>
        <div class="inventor-info">
          <div class="info-row">
            <label>ì„±ëª…</label>
            <input type="text" name="inventor_name_${num}" id="inventor_name_${num}" class="text-input" placeholder="í™ê¸¸ë™" required maxlength="50">
          </div>
          <div class="info-row">
            <label>ì£¼ì†Œ</label>
            <input type="text" name="inventor_address_${num}" id="inventor_address_${num}" class="text-input" placeholder="ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬..." required maxlength="200">
          </div>
          <div class="info-row">
            <label>êµ­ì </label>
            <select name="inventor_nationality_${num}" id="inventor_nationality_${num}" class="select-input" required>
              <option value="ëŒ€í•œë¯¼êµ­">ëŒ€í•œë¯¼êµ­</option>
              <option value="ë¯¸êµ­">ë¯¸êµ­</option>
              <option value="ì¼ë³¸">ì¼ë³¸</option>
              <option value="ì¤‘êµ­">ì¤‘êµ­</option>
              <option value="ë…ì¼">ë…ì¼</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>
        </div>
      </div>
    `;
  }

  window.removeInventor = function(num) {
    const item = document.querySelector(`.inventor-item[data-inventor="${num}"]`);
    if (item) {
      item.remove();
      reorderInventors();
    }
  };

  function reorderInventors() {
    document.querySelectorAll('.inventor-item').forEach((item, i) => {
      const newNum = i + 1;
      item.setAttribute('data-inventor', newNum);
      item.querySelector('h4').textContent = `ë°œëª…ì ${newNum}`;

      const btn = item.querySelector('.remove-inventor-btn');
      btn.setAttribute('onclick', `removeInventor(${newNum})`);
      btn.style.display = newNum === 1 ? 'none' : 'inline-block';

      ['name', 'address', 'nationality'].forEach(field => {
        const input = item.querySelector(`[name^="inventor_${field}_"]`);
        if (input) {
          input.name = `inventor_${field}_${newNum}`;
          input.id = `inventor_${field}_${newNum}`;
        }
      });
    });
    inventorCount = document.querySelectorAll('.inventor-item').length;
  }

  function updateCharCounter(input) {
    const counter = input.nextElementSibling;
    if (counter?.classList.contains('char-counter')) {
      const count = input.value.length;
      const max = input.getAttribute('maxlength');
      const display = counter.querySelector('.current-count');
      if (display) display.textContent = count;
      counter.classList.toggle('limit-reached', count >= max * 0.9);
    }
  }

  function showMessage(msg) {
    if (App.utils?.showNotification) {
      App.utils.showNotification(msg);
    } else {
      console.log(msg);
    }
  }

  function createNewTemplate() {
    const currentContent = getCurrentContent();
    
    if (currentContent?.trim()) {
      if (!confirm('í˜„ì¬ ì‘ì„± ì¤‘ì¸ íŠ¹í—ˆ ëª…ì„¸ì„œê°€ ìˆìŠµë‹ˆë‹¤. íˆìŠ¤í† ë¦¬ì— ì €ì¥í•˜ê³  ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      saveToHistory();
    }
    
    resetAll();
    showMessage('ğŸ†• ìƒˆë¡œìš´ í…œí”Œë¦¿ ì‘ì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
    focusFirst();
  }

  function getCurrentContent() {
    return window.currentDraftContent || App.data?.currentDraftContent || '';
  }

  function saveToHistory() {
    const title = document.getElementById('tech_name')?.value?.trim() || 'ì €ì¥ëœ íŠ¹í—ˆ ëª…ì„¸ì„œ';
    
    if (App.data) App.data.currentDraftContent = getCurrentContent();
    
    if (App.history?.addToHistory) {
      App.history.addToHistory(title);
      showMessage('í˜„ì¬ ì‘ì—…ì´ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  }

  function resetAll() {
    window.currentDraftContent = '';
    window.CURRENT_TEMPLATE_ID = null;
    if (App.data) {
      App.data.currentDraftContent = '';
      App.data.currentEvaluation = '';
      App.data.currentDraftId = null;
      App.data.evaluationCached = false; // í‰ê°€ ìºì‹œ ì´ˆê¸°í™”
      App.data.currentRecommendation = ''; // ì¶”ì²œ ë‚´ìš©ë„ ì´ˆê¸°í™”
    }
    
    resetForm();
    resetDraft();
    resetInventors();
  }

  function resetForm() {
    const form = document.getElementById('templateForm');
    if (form) {
      form.reset();
      form.querySelectorAll('.current-count').forEach(el => el.textContent = '0');
      form.querySelectorAll('.limit-reached').forEach(el => el.classList.remove('limit-reached'));
      const corp = document.querySelector('input[name="applicant_type"][value="corporation"]');
      if (corp) {
        corp.checked = true;
        toggleApplicantType();
      }
    }
  }

  function resetDraft() {
    const noMsg = document.getElementById('noDraftMessage');
    const draft = document.getElementById('draftContent');
    
    if (noMsg) noMsg.style.display = 'block';
    if (draft) {
      draft.style.display = 'none';
      draft.querySelectorAll('.markdown-content, #draft_text').forEach(el => el.remove());
    }
  }

  function resetInventors() {
    const container = document.getElementById('inventors-container');
    if (container) {
      container.innerHTML = createInventorHTML(1);
      inventorCount = 1;
    }
  }

  function focusFirst() {
    setTimeout(() => {
      const first = document.getElementById('tech_name');
      if (first) {
        first.focus();
        first.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 300);
  }

  if (typeof window.App !== 'undefined') {
    if (!window.App.template) window.App.template = {};
    window.App.template.createNew = createNewTemplate;
    
    // í‰ê°€ ìºì‹œ ë¬´íš¨í™” í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    if (!window.App.evaluation) window.App.evaluation = {};
    window.App.evaluation.invalidateCache = function() {
      if (App.data) {
        App.data.evaluationCached = false;
        App.data.currentEvaluation = '';
        console.log('í‰ê°€ ìºì‹œê°€ ë¬´íš¨í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    };
  }

})();
